services:
  # ----------------------------
  # API (runtime)
  # ----------------------------
  ezenity_api:
    build:
      context: .
      dockerfile: Ezenity.API/Dockerfile
      # IMPORTANT: do NOT set target here.
      # The Dockerfile's final stage is the runtime image.
      target: runtime
    image: ezenity/project-ezenity-api:${TAG:-latest}
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      ASPNETCORE_ENVIRONMENT: "Production"

      # IMPORTANT: must match your code's expected key:
      # connectionStringSettings.WebApiDatabase
      #- ConnectionStrings__WebApiDatabase=${EZENITY_DB_CONN}
      ConnectionStrings__WebApiDatabase: "Server=host.docker.internal;Port=3306;Database=${EZENITY_DATABASE_NAME};User=${EZENITY_DATABASE_USER};Password=${EZENITY_DATABASE_PASSWORD};"

      # IMPORTANT: your code binds AppSettings (AppSettingsFactory.Create)
      AppSettings__Secret: "${EZENITY_SECRET_KEY}"
      AppSettings__BaseUrl: "${EZENITY_BASE_URL}"
      AppSettings__RefreshTokenTTL: "${EZENITY_REFRESH_TOKEN_TTL}"

      AppSettings__SmtpUser: "${EZENITY_SMTP_USER}"
      AppSettings__SmtpPass: "${EZENITY_SMTP_PASSWORD}"
      AppSettings__SmtpHost: "${EZENITY_SMTP_HOST}"
      AppSettings__SmtpPort: "${EZENITY_SMTP_PORT}"
      AppSettings__SmtpEnabledSsl: "${EZENITY_SMTP_ENABLE_SSL}"
      AppSettings__EmailFrom: "${EZENITY_EMAIL_FROM}"
      AppSettings__EmailMessageIdDomain: "${EZENITY_EMAIL_MESSAGE_ID_DOMAIN}"
      AppSettings__EmailTemplateBasePath: "${EZENITY_EMAIL_TEMPLATE_BASE_PATH}"

      # Your Startup.cs production CORS reads this env var directly:
      # Configuration["EZENITY_ALLOWED_ORIGINS"]
      EZENITY_ALLOWED_ORIGINS: "${EZENITY_ALLOWED_ORIGINS}"
    ports:
      - "127.0.0.1:5001:8080"
    networks:
      - ezenity_net
    # Program.cs writes to /var/log/ezenity_api_out.log
    volumes:
      - /srv/ezenity/logs/ezenity_api:/var/log
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ----------------------------
  # Ezenity Frontend
  # ----------------------------
  ezenity_frontend:
    build:
      context: ./Ezenity_Frontend
      dockerfile: Dockerfile
    image: ezenity/ezenity-frontend:${TAG:-latest}
    restart: unless-stopped
    ports:
      - "127.0.0.1:4200:80"
    networks:
      - ezenity_net

  # ----------------------------
  # Trina Frontend
  # ----------------------------
  trina_frontend:
    build:
      context: ./Ezenity_Trina
      dockerfile: Dockerfile
    image: ezenity/changemakercreations-frontend:${TAG:-latest}
    restart: unless-stopped
    ports:
      - "127.0.0.1:4201:80"
    networks:
      - ezenity_net

  # ----------------------------
  # DB Migrator (runs on-demand)
  # ----------------------------
  ezenity_migrator:
    build:
      context: .
      dockerfile: Ezenity.API/Dockerfile
      target: migrator
    image: ezenity/project-ezenity-migrator:${TAG:-latest}
    restart: "no"
    env_file:
      - ./.env
    environment:
      ASPNETCORE_ENVIRONMENT: "Production"
      #ConnectionStrings__WebApiDatabase: "${EZENITY_DB_CONN}"
      ConnectionStrings__WebApiDatabase: "Server=host.docker.internal;Port=3306;Database=${EZENITY_DATABASE_NAME};User=${EZENITY_DATABASE_USER};Password=${EZENITY_DATABASE_PASSWORD};"
      AppSettings__Secret: "${EZENITY_SECRET_KEY}"
    networks:
      - ezenity_net
    # Don't start by default. Only when explicitly invoked.
    profiles: ["migrate"]
    # If your migrator image doesn't have an entrypoint, set it here.
    # This assumes your migrator target provides dotnet-ef at /tools/dotnet-ef
    entrypoint: ["bash", "-lc"]
    command:
      - >
        /tools/dotnet-ef database update
        --project Ezenity.Infrastructure
        --startup-project Ezenity.API
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  ezenity_net:
    driver: bridge
