services:
  # ----------------------------
  # API (runtime)
  # ----------------------------
  ezenity_api:
    build:
      context: .
      dockerfile: Ezenity.API/Dockerfile
      # IMPORTANT: do NOT set target here.
      # The Dockerfile's final stage is the runtime image.
      target: runtime
    image: ezenity/project-ezenity-api:${TAG:-latest}
    restart: unless-stopped
    container_name: ezenity-api
    env_file:
      - ./.env
    environment:
      # ASP.NET Core Settings
      ASPNETCORE_ENVIRONMENT: "${ASPNETCORE_ENVIRONMENT}"
      DOTNET_PRINT_TELEMETRY_MESSAGE: "${DOTNET_PRINT_TELEMETRY_MESSAGE}"

      # Database Settings
      ConnectionStrings__WebApiDatabase: "${EZENITY_DATABASE_CONN}"
      EZENITY_DATABASE_CONN: "${EZENITY_DATABASE_CONN}"
      EZENITY_DATABASE_USER: "${EZENITY_DATABASE_USER}"
      EZENITY_DATABASE_NAME: "${EZENITY_DATABASE_NAME}"
      EZENITY_DATABASE_PASSWORD: "${EZENITY_DATABASE_PASSWORD}"
      EZENITY_DATABASE_HOST: "${EZENITY_DATABASE_HOST}"
      EZENITY_DATABASE_PORT: "${EZENITY_DATABASE_PORT}"

      # File Settings
      FileStorage__RootPath: "${EZENITY_FILES_ROOT}"
      FileStorage__MaxUploadBytes: "${EZENITY_FILES_MAX_BYTES}"
      EZENITY_FILES_ROOT: "${EZENITY_FILES_ROOT}"
      EZENITY_FILES_MAX_UPLOAD_BYTES: "${EZENITY_FILES_MAX_BYTES}"
      EZENITY_FILES_ALLOWED_EXTENSIONS: "${EZENITY_FILES_ALLOWED_EXTENSIONS}"

      # API Settings
      # Your Startup.cs production CORS reads this env var directly:
      # Configuration["EZENITY_ALLOWED_ORIGINS"]
      EZENITY_BASE_URL: "${EZENITY_BASE_URL}"
      EZENITY_ALLOWED_ORIGINS: "${EZENITY_ALLOWED_ORIGINS}"
      EZENITY_REFRESH_TOKEN_TTL: "${EZENITY_REFRESH_TOKEN_TTL}"

      # Email Settings
      EZENITY_SMTP_USER: "${EZENITY_SMTP_USER}"
      EZENITY_SMTP_PASSWORD: "${EZENITY_SMTP_PASSWORD}"
      EZENITY_SMTP_HOST: "${EZENITY_SMTP_HOST}"
      EZENITY_SMTP_PORT: "${EZENITY_SMTP_PORT}"
      EZENITY_SMTP_ENABLED_SSL: "${EZENITY_SMTP_ENABLED_SSL}"
      EZENITY_EMAIL_FROM: "${EZENITY_EMAIL_FROM}"
      EZENITY_EMAIL_MESSAGE_ID_DOMAIN: "${EZENITY_EMAIL_MESSAGE_ID_DOMAIN}"
      EZENITY_EMAIL_TEMPLATE_BASE_PATH: "${EZENITY_EMAIL_TEMPLATE_BASE_PATH}"

      # Security Settings
      EZENITY_SECRET_KEY: "${EZENITY_SECRET_KEY}"
      EZENITY_ACCESS_TOKEN: "${EZENITY_ACCESS_TOKEN}"

      # Logging Settings
      EZENITY_LOGS_API_DIR: "${EZENITY_LOGS_API_DIR}"

      # Debugging Settings
      Logging__LogLevel__Microsoft.Hosting.Lifetime: "Information"
      Logging__LogLevel__Microsoft: "Information"

    ports:
      - "127.0.0.1:5001:8080"
    networks:
      - ezenity_net
    # Program.cs writes to /var/log/ezenity_api_out.log
    volumes:
      - /srv/ezenity/logs/ezenity_api:/var/log
      # Persist uploaded files outside the container
      - /src/ezenity/storage/ezenity_files:/data/files
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ----------------------------
  # Ezenity Frontend
  # ----------------------------
  ezenity_frontend:
    build:
      context: ./Ezenity_Frontend
      dockerfile: Dockerfile
    image: ezenity/ezenity-frontend:${TAG:-latest}
    restart: unless-stopped
    ports:
      - "127.0.0.1:4200:80"
    networks:
      - ezenity_net

  # ----------------------------
  # Trina Frontend
  # ----------------------------
  trina_frontend:
    build:
      context: ./Ezenity_Trina
      dockerfile: Dockerfile
    image: ezenity/changemakercreations-frontend:${TAG:-latest}
    restart: unless-stopped
    ports:
      - "127.0.0.1:4201:80"
    networks:
      - ezenity_net

  # ----------------------------
  # DB Migrator (runs on-demand)
  # ----------------------------
  ezenity_migrator:
    build:
      context: .
      dockerfile: Ezenity.API/Dockerfile
      target: migrator
    image: ezenity/project-ezenity-migrator:${TAG:-latest}
    restart: "no"
    env_file:
      - ./.env
    environment:
      # ASP.NET Core Settings
      ASPNETCORE_ENVIRONMENT: "${ASPNETCORE_ENVIRONMENT}"

      # Database Settings
      ConnectionStrings__WebApiDatabase: "${EZENITY_DATABASE_CONN}"
      EZENITY_DATABASE_CONN: "${EZENITY_DATABASE_CONN}"

      # API Settings
      # Your Startup.cs production CORS reads this env var directly:
      # Configuration["EZENITY_ALLOWED_ORIGINS"]
      EZENITY_BASE_URL: "${EZENITY_BASE_URL}"
      EZENITY_ALLOWED_ORIGINS: "${EZENITY_ALLOWED_ORIGINS}"
      EZENITY_REFRESH_TOKEN_TTL: "${EZENITY_REFRESH_TOKEN_TTL}"

      # Security Settings
      EZENITY_SECRET_KEY: "${EZENITY_SECRET_KEY}"

      # Logging Settings
      EZENITY_LOGS_MIGRATOR_DIR: "${EZENITY_LOGS_MIGRATOR_DIR}"

    networks:
      - ezenity_net
    # Don't start by default. Only when explicitly invoked.
    profiles: ["migrate"]
    # If your migrator image doesn't have an entrypoint, set it here.
    # This assumes your migrator target provides dotnet-ef at /tools/dotnet-ef
    entrypoint: ["bash", "-lc"]
    command:
      - >
        /tools/dotnet-ef database update
        --project Ezenity.Infrastructure
        --startup-project Ezenity.API
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  ezenity_net:
    driver: bridge
